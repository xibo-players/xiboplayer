name: Deprecate old npm versions

on:
  workflow_dispatch:

permissions:
  contents: read

jobs:
  deprecate:
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v4

      - uses: actions/setup-node@v4
        with:
          node-version: '22'
          registry-url: 'https://registry.npmjs.org'

      - name: Deprecate all versions except 0.5.13
        env:
          NODE_AUTH_TOKEN: ${{ secrets.NPM_TOKEN }}
        run: |
          KEEP="0.5.13"
          MSG="Outdated: upgrade to $KEEP"

          for pkg_dir in packages/*/; do
            [ ! -f "$pkg_dir/package.json" ] && continue
            name=$(node -p "require('./${pkg_dir}package.json').name")
            private=$(node -p "require('./${pkg_dir}package.json').private || false")

            # Skip private packages
            [ "$private" = "true" ] && continue

            echo "=== $name ==="
            versions=$(npm view "$name" versions --json 2>/dev/null || echo "[]")
            for v in $(echo "$versions" | node -e "
              let d='';
              process.stdin.on('data',c=>d+=c);
              process.stdin.on('end',()=>{
                const arr = JSON.parse(d);
                const vs = (Array.isArray(arr) ? arr : [arr]).filter(v => v !== '$KEEP');
                console.log(vs.join('\n'));
              });
            "); do
              echo "  Deprecating $name@$v"
              npm deprecate "$name@$v" "$MSG"
            done
          done
          echo "Done"
